\chapter{Magnetic Field Derivation}
\label{cha:derivation}

In constructing a rudimentary algorithm to quantify the effect of magnetic draping on HVCs, as in section \ref{sec:outline}, it is important to pay attention to the validity of the methods being employed and less the accuracy. As an inaccurate methodology can be improved using better data, removing assumptions, and more precision, however an invalid methodology cannot provide a proper estimate whatsoever.

\section{Assumptions}
\label{sec:assumptions}

Due to the significant limitations in available data, the use of assumptions is necessary to begin the process of rough evaluation. Several assumptions were employed in the process of evaluation, some of which are less than satisfactory at contributing an accurate answer to the research question. Again, it is highly important to note that goal is to ensure the validity of the method is sound and to ensure the method's manipulability, but not necessarily provide a guarantee of accuracy and precision.


The first major assumption is that the ionisation fraction of the Galactic halo is approximately constant, i.e. gas in the halo is well-mixed. This does not account for major sources of heterogeneity caused by HVCs (a desired outcome) or other ionised regions such as the Magellanic Clouds (an undesired outcome). It is not necessarily unreasonable to assume this, especially if the region of analysis per HVC is under 4 square degrees.


Simulation data can be used to analyse the problematic nature of assuming a constant ionisation fraction \citep{ID23}. However, it is difficult to apply simulation data to observational data due to the sheer variety of analysis capable of being performed by simulations. For now, it is 'good enough' to rely on that assumption from \cite{ID23} that the ionisation fraction is high and constant.


The second major assumption is that the weighted average of the HI column density surrounding a HVC is linearly proportional to, and biased towards the peak column density in the centre of the HVC. This is an assumption that only works under the consideration of averages, as HI column density is certainly not uniform within clouds, as mentioned in \cite{ID69}. It also neccessitates some level of correlation between line of sight magnetic fields and their uncertainties (a consequence of Poisson noise).


Both above assumptions can, and should, be taken to be unreasonable for providing an accurate estimate of magnetic field strength. However, the result of applying both assumptions is that the line-of-sight magnetic field strength is linearly proportional to the faraday depth with a scaling constant unique to each HVC – as demonstrated in later section \ref{sec:los_dev}. This greatly simplifies the analysis, without loss of validity, primarily due to the method of calculation explained by \cite{ID27} and in section \ref{sec:los_dev}.


The third core assumption is that HVCs will appear as approximately circular within the field. Meaning that to distinguish between the surrounding medium and HVC RM grids, a simple circular method can be applied. As seen from the HI plots in figure \ref{fig:all_hvcs}, this assumption appears to only be correct in particular cases. But do note that the HI background discriminates for high-VLSR HI emission.


All three assumptions additionally meet the desired goal of an alterable method. As discussed in the discussion and conclusions sections \ref{ssec:B2} and \ref{sec:future}, these three assumptions can be dropped in the presence of more detailed data or more rigorous methodologies manipulated from the one described in this paper.


Lastly, a very typical assumption made is that the RM contribution along a line of sight is averaged across said line of sight. This is not necessarily correct; however, it is a fair assumption that most past literature has made to deconstruct the integral as seen in \cite{ID27, ID3, ID26}. This makes the fourth assumption.

\begin{figure}
    \includegraphics[width=11.2cm]{"Selected_HVCs_new.png"}
    \centering
    \caption{All 13 HVCs used in the analyis of the primary outcome. The HI column density is represented using a greyscale image background. The RMs are represented by circular markers, their size equal to the magnitude and the colour representative of their sign with Red being positive. The black circle is the deliniation between in-HVC and out-HVC populations, and the black 'x' indicates the centre of the HVC.}
    \label{fig:all_hvcs}
\end{figure}

\begin{figure}
    \includegraphics[width=11.2cm]{"Selected_HVCs_new_average_subtraction.png"}
    \centering
    \caption{The same set of HVCs in HI with RM overlays, displayed the same as in \ref{fig:all_hvcs}. However, instead of using the interpolation as a method of correction, the mean uncorrected RM value is subtracted out.}
    \label{fig:all_hvcs_avg}
\end{figure}


\section{Derivation of Line-of-Sight Magnetic Fields}
\label{sec:los_dev}

As from equation \ref{eq:rm_integral}, there is a relationship between the line-of-sight magnetic field and the faraday depth. By removing foreground contributions to the faraday depth, one can isolate the specific contribution of the line-of-sight magnetic field made by the HVC. At the same time, the fourth assumption can be used to solve evaluate the integral, resulting as follows \citep{ID26}:


\begin{equation}
    \frac{\left<B_{\parallel}\right>}{\mu\mathrm{G}}=\frac{\left<\Phi_{\mathrm{cor}}\right>}{0.81\left<n_e\right>L_{H^+}}
\label{eq:B_intermediate}
\end{equation}


Where $\left<B_{\parallel}\right>$ is the average line-of-sight magnetic field in \textmu G, $\Phi_{\mathrm{cor}}$ is the corrected faraday depth in $\mathrm{rad m}^{-2}$, $n_e$ is the electron density in $\mathrm{cm}^{-3}$, and $L_{H^+}$ is the HVC path length in pc. From this equation, \cite{ID27} derives a simplified equation that eliminates the need to calculate the electron density and path length:


\begin{equation}
    \frac{B_{\parallel}}{\mu\mathrm{G}}=3.80\times10^{18}\frac{\Phi_{\mathrm{cor}}}{X\left<N_{HI}\right>}
\label{eq:the_equation}
\end{equation}


Where $X$ is the unitless ionisation fraction, and $\left<N_{HI}\right>$ is the weighted average HI column density over the region being analysed, measured in $\mathrm{cm}^{-2}$. This equation can only be derived under the first assumption. Additionally, the use of the average HI column density is intrinsically tied to the second assumption.


Applying both assumptions and utilizing this equation demonstrates that the line-of-sight magnetic field is linearly proportional to the faraday depth. For every RM sampling point, the magnetic field was calculated using this equation. With the assumption that the ionisation fraction is approximately unity, and the average HI column density is equal to the peak HI column density of the HVC. As aforementioned, these values act more as simple placeholders for more detailed analysis, being within an order of magnitude is all that is necessary for the aims of this report.


At this point, it is important to distinguish between what is called 'virtual magnetic field' and 'actual magnetic field'. For any individual RM point source, there are a lot of interferences that may make the resulting magnetic field not representative of the actual magnetic field at that point – more specifically, the turbulent nature of gas mixing in the halo and HVC \citep{ID69, ID30, ID16}. Thus, calculating the magnetic field value associated with a single RM point source is to be considered 'virtual' – an approximation to the actual magnetic field within a degree of uncertainty. It is only through the statistical analysis of multiple virtual magnetic fields that an actual magnetic field value can be derived. As the combination ensures that turbulence effects are accounted for, due to it being unlikely that random contributions to line-of-sight magnetic fields can become uniform at the point of observation.


Despite the detailed analysis conducted in section \ref{cha:FR}, it was decided that the non-altered interpolated sky map be used to correct RM contributions. This is due to most already-existing literature relying on this method. From figure \comment{FIXME}, which displays histograms of the corrected and uncorrected line-of-sight magnetic field points surrounding HVCs. From the figure, it is demonstrated that the Hutschenreuter map can remove the anisotropy of the ISM by turning an uncorrected bimodal symmetric distribution into a normal distribution centred at zero. However, it also is apparent that the correction can introduce a significantly higher variance in the data, shown in the ridge-like structures in figure \ref{fig:all_hvcs}, which presents HI images of all 13 HVCs, the overlapping RM grids, and the cropped HI fields. The filtered Moss catalogue, including all 13 HVCs is displayed in appendix \ref{sec:appendixB}.

%\begin{figure}
%    \includegraphics[width=10cm]{"Virtual_B_All_HVCs.png"}
%    \centering
%    \caption{Two histograms describing the calculated line-of-sight virtual magnetic field strengths within a certain distance to the 13 sample HVCs. The red histogram uses uncorrected. The green histogram uses corrected RMs.}
%    \label{fig:anisotropy}
%\end{figure}


\section{KS Testing}
\label{sec:KStest}

Before evaluating the effect of magnetic draping on HVCs, it is important to first confirm that there is a detectable magnetic field to analyse. To do this, the KS test was employed. The set of RM grid points for each HVC collated in section \ref{ssec:hvc_snapshot} include any grid point within $2 - 2\pi$ degrees of the HVC centre, depending on HVC size. Employing assumption three, two separate populations can be formed by delineating RMs inside and outside a certain circular distance from the HVC centre. The specific radius of delineation was the average value between the Moss catalogue's 'dx' and 'dy' values (i.e. its cartesian dimensions). All sampling points within the defined circle is apart of the “HVC RMs” population, and the ones outside the circle are apart of the “Background RMs” population.


Due to the linear proportionality between the faraday depth and virtual magnetic field, these two values are interchangeable when doing statistical analysis on the individual HVC level. This allows the KS test to be performed on the set of virtual magnetic fields associated with grid points directly, instead of the faraday depth.


A two-sample, two-tailed, KS test was performed comparing both the background and HVC virtual magnetic fields. A critical p-value of 0.001 was assumed to determine if a significant magnetic field was detected. Table \ref{tab:KStest} shows the KS test results applied to each HVC. Out of the 13 HVCs tested, 10 HVCs (77\%) had a significant difference between both populations. This is a promising confirmation of the hypothesis presented by the literature, that magnetic draping is an existing phenomenon.

\begin{table}
    \centering
    \begin{tabular}{l l l l l}
        \hline
        \multirow{2}{*}{\bfseries Name} & \multicolumn{2}{l}{\bfseries Corrected RMs} & \multicolumn{2}{l}{\bfseries Raw RMs} \\
        & Statistic & p-value & Statistic & p-value \\
        \hline
        \csvreader[head to column names]{"../../Resources/CSV/KStest_proc.csv"}{}
        {\\\csvcoli & \csvcolii & \csvcoliii & \csvcolviii & \csvcolix}
        \\
        \hline
    \end{tabular}
    \caption{A table describing the KS test results for each HVC.}
    \label{tab:KStest}
\end{table}

\section{Effect of Missing Data}
\label{sec:Missing}

T


\section{Mathematical methods to evaluate HVC Magnetic Fields}
\label{sec:evaluation}

For the HVCs which did have detectable magnetic fields, the next step is to estimate the strength of the magnetic field draping over each HVC. Previous analyses of the Smith Cloud, such as in \cite{ID5, ID26}, utilises a weighted average to determine the magnetic field strength. However, this method may not be transferable to a generalised algorithm. In \cite{ID5, ID26}, due to analysing one single and large object, it is possible to divide the object into several smaller sections for analysis. It is not possible to do this especially given the limitations created by assumption three.


While the background virtual magnetic field population will generally follow the expected normal distribution, the in-HVC population can come in multiple varieties including: skewed normal distributions, where the HVC is travelling side-on; bimodal distributions, where the HVC is travelling towards or away from Earth; or sinc distributions - similar to the bimodal distribution, however under the unique case where the HVC magnetic field perfectly overlaps with the corrected background, resulting in a depopulation of virtual magnetic fields where the HVC magnetic field strength should align to. More is provided on these morphologies in section \ref{sec:toy_models}.


The more complex HVC virtual magnetic field distribution combined with the oversimplified morphology model means that using a weighted average is dubious in validity at best - the same applies to most forms of modal analysis including gaussian fitting i.e. any method that can not account for antimodal or multimodal analysis. Henceforth, this report proposes two new methods to determine the magnetic field strength surrounding HVCs under the simplified morphological model. Sections \ref{ssec:KS_EDF} and \ref{ssec:sigma_sub} attempts to justify the mathematical validity of these two methods, section \ref{sec:toy_models} demonstrates validity further through the application of a simple toy model, and section \ref{sec:results} shows both the results of using these methods, with some further post-hoc justifications demonstrated in output data.


Regardless of the hypothesis that the weighted average is inadequate, it will still be included as a method in the analysis of both the toy model and actual results, for the point of either disproving or validating said hypothesis.


\subsection{KS-EDF Method}
\label{ssec:KS_EDF}

The first proposed method relies on both the results of the KS test and the Empirical Distribution Functions (EDFs) of the in-HVC and out-HVC populations required to evaluate the KS statistic. The x-axis location of the KS statistic is where the distribution of the two populations differs the greatest. And thus, it is not unreasonable to state that the magnetic field strength corresponds to this location in some manner. This is shown in figure \ref{fig:KSdiff}, where the red line denotes the KS statistic's length and x-axis position.


\begin{figure}
    \includegraphics[width=10cm]{"KS_diff.png"}
    \centering
    \caption{A diagram representing the physical evaluation of the KS-EDF method. The graph shows the EDFs of inside and outside populations for an example HVC. The lines drawn on the diagram represent the statistic value and the KS-EDF magnetic field value.}
    \label{fig:KSdiff}
\end{figure}

The second step in this method is to further remove background interference as explained in section \ref{sec:los_dev}. This can be done by finding the x-axis location at which the density in the background population EDF equals that of the density of the HVC population EDF at the KS-derived x-axis location. This step has the effect of removing any potential deviation from zero that the magnetic field in the background has due the ridge-like structures, which will appear in the EDF as either (i) any deviation from a standard normal distribution, or (ii) a deviation from the centre of the normal distribution as a function of its uncertainty.


This is shown in figure \ref{fig:KSdiff} with the black line – the length of the black line representing the final assessed magnetic field value. In this case, the background population in orange is approximately normal. So, case (ii) from the paragraph above is demonstrated.


The second step is not always valid, due to the inherent variability in the EDFs and only being loosely correlated with meaningful population variables. Hence the necessity of further statistical analysis.


\subsection{Uncertainy Subtraction}
\label{ssec:sigma_sub}

A more legitimate method involves the reverse-propagation of uncertainties. An assumption can be made that for some HVCs, there is an inherent variation in the magnetic field as one looks at different locations in the defined morphological circle, appearing as a 'ring' of changing numerical parity. This inherent variance is denoted as $\sigma_{\mathrm{true}}^2$.


Additionally, each virtual magnetic field measurement comes with a measurement uncertainty, denoted as $\sigma_{\mathrm{meas.}}$. Propagating these two uncertainties would give what should be the observed variance, $\sigma_{\mathrm{obs}}^2$:


\begin{equation}
    \sigma_{\mathrm{obs}}^2 = \sigma_{\mathrm{true}}^2 + \sigma_{\mathrm{meas.}}^2
\label{eq:var_sub_1}
\end{equation}


The observed uncertainty can be calculated by taking the statistical standard deviation of the population, and the measurement uncertainty can be averaged to give a whole-population measurement uncertainty approximation. This allows for equation \ref{eq:var_sub_1} can be reversed to derive the 'true' variance in the magnetic field:


\begin{equation}
    \sigma_{\mathrm{true}} = \sqrt{\mathrm{Var}\left(B_{\parallel, \mathrm{virt}}\right) + {\left<\sigma_{B_{\parallel, \mathrm{virt}}}\right>}^2}
\label{eq:var_sub_2}
\end{equation}


By definition of standard deviation, the corresponding true variance can be equivocated to the average separation between virtual magnetic fields in the population, thus quantifying the inherent variation in the HVC magnetic field, i.e. the magnetic field strength.


The same can be done to the background population, instead to detect the potential interferences of the ridge-like structures of the magnetic field. This can be used to subtract out the background interferences that were included in the derivation of the true in-HVC variance.


A clear potential source of error in this method comes in the fact that the standard deviation is positive, affecting the validity in two separate ways: (i) cases where the average measurement uncertainty is larger than the statistical standard deviation, resulting in a complex uncertainty; (ii) cases where the magnetic field strength \textit{should} be negative but is calculated as positive (before the true background variance is subtracted). Case (i) does not invalidate the method outright but does mean that 'bad data' might have to be thrown out. This happened in only one case as seen in section \ref{sec:results}. Case (ii) is irrelevant in the conclusion, as the parity of the magnetic field is not a factor being analysed. However, the if the main concern is if the background and HVC true variances differ in sign. This is not of concern because if there is a sign difference, the background ridge-like structures would cancel-out the presence of HVC magnetic fields, resulting in every invalidating occurrence of case (ii) necessarily leading to case (i).


To reiterate, the caveats and assumptions described in this derivation may appear as mathematically or intuitively valid, however it is worthwhile to test things via toy modelling and statistical analysis.


\section{Toy Model Analysis}
\label{sec:toy_models}

E

\begin{equation}
    P_{\mathrm{image}} (x,y;k,\alpha,\beta,\gamma) = k P_{\mathrm{background}}(x,y) + P_{\mathrm{HVC}} (x,y;\alpha,\beta,\gamma)
    \label{eq:image_toy}
\end{equation}

\begin{equation}
    P_{\mathrm{HVC}} (x,y) = \int_{-\infty}^{\infty}{\mathrm{R}(\alpha,\beta,\gamma)\vec{B}_{\mathrm{sim}}(\mathrm{R}^{-1}(\alpha,\beta,\gamma)\cdot(x,y,z)) \cdot \hat{z}dz}
    \label{eq:toy_vec}
\end{equation}

\begin{equation}
    \vec{B}_{\mathrm{sim}}(x,y,z) =
    \begin{cases}
        \begin{bmatrix} x \\ y \\ z \end{bmatrix} & x\leq 0 \\
        \begin{bmatrix} x \\ y \\ z \end{bmatrix} & x > 0
    \end{cases}
    \label{eq:toy_mag}
\end{equation}

\section{Magnetic Field Results}
\label{sec:results}

The results of each method are compiled in table \ref{tab:Bdev}. Out of 11 HVCs that had detectable magnetic fields, 10 are listed. While HVC G133.5-75.6-294 had a detectable magnetic field, the variance subtraction method returned a non-real value, indicating that the HVC has 'bad data' (as from section \ref{ssec:sigma_sub} this implies an overestimation of measurement uncertainty).


\begin{table}
    \centering
    \begin{tabular}{l l l l}
        \hline
        \multirow{2}{*}{\bfseries Name} & \multicolumn{3}{l}{\bfseries Abs. Magnetic Field  $|B_{\parallel}|$ (\textmu G)} \\
        & Wgt. Avg. & KS-EDF & $\sigma$-Sub. \\
        \hline
        \csvreader[head to column names]{"../../Resources/CSV/results_final_filtered_proc.csv"}{}
        {\\\csvcoli & \csvcolxv $\pm$ \csvcolxviii & \csvcolvi $\pm$ \csvcolxix & \csvcolxi $\pm$ \csvcolxx}
        \\
        \hline
    \end{tabular}
    \caption{A table describing the magnetic field derivations for each HVC. HVCs from the sample of 13 that had no significant KS test detection, or an invalid variance subtraction result are removed.}
    \label{tab:Bdev}
\end{table}


The distributions of the results are displayed in the boxplots of figure \ref{fig:BBox}, which includes the mean (green triangle) and median (orange line) of each set. The Smith Cloud magnetic field as discussed in section \ref{sec:sc} is marked with a red line, and the upper bound as discussed by the \citeauthor[][simulations]{ID23} in section \ref{ssec:draping} is marked in blue. Both values at 8 and 3 {\textmu}G respectively act as upper bounds for the strength of these HVCs.


\begin{figure}
    \includegraphics[width=\textwidth]{"B_Boxplots.png"}
    \centering
    \caption{A boxplot representing the absolute-value magnetic field of each HVC for both derivational methods. The red and blue dotted lines indicate two upper bounds, one set by the \citeauthor[][simulations]{ID23}, and the other by the Smith Cloud respectively.}
    \label{fig:BBox}
\end{figure}


From figure \ref{fig:BBox}, the magnetic field strengths are overall higher compared to the hypothesised estimate of being on the order of magnitude of 0.1 {\textmu}G. The three methods appear to visually agree with each other approximately, with the KS-EDF overestimating the magnetic field value, the Variance Subtraction having the greatest spread, and the Weighted Average having the largest tail. It is important to note that due to the logarithmic scale used, the mean is inherently biased to visually appear at higher values. However, the use of a logarithmic scale is still justified due to the order-of-magnitude levels of error.


\comment{FIXME} displays the relationship between the calculated magnetic field and the absolute GSR velocity. With all three methods, there appears to be a weak negative correlation in the form of:

\subsection{Uncertainties}
\label{ssec:results_uncertainties}

With each method comes a unique derivation of uncertainties. The uncertainty in the weighted mean is given as trivial – calculated separately for the HVC and background populations, and then propagated.


The uncertainty in the KS-EDF statistic reflects the inherent variability in the method and is calculated by the Euclidean addition of the average measurement uncertainty of both the HVC and background populations. This corresponds to the propagation of virtual magnetic field uncertainties shown in figure \ref{fig:KSdiff}, where the black line is the source of determining the uncertainties to propagate.


The uncertainty in the variance subtraction method was calculated via bootstrap resampling with replacement. The number of samples generated per population is equal to the size of the population being analysed. Once the HVC and background population uncertainties were evaluated, the two uncertainties were propagated to produce the listed result.

\subsection{Statistical Comparison of Methods}
\label{ssec:results_stats}

In addition to the reduced chi-squared statistic for the toy model analysis shown in section \ref{sec:toy_models}, another reduced chi-squared analysis was performed on the magnetic field values calculated for each HVC. The point of comparison is the weighted average. While the hypothesis stated in section \ref{sec:evaluation} describes the potential problems with using the weighted average, the distribution in figure \ref{fig:BBox} and the values in table \ref{tab:Bdev} demonstrate that the weighted average is still a potentially robust method.


The weighted average has the lowest uncertainties out of the three methods and given its use in previous literature, it was used as the 'expected' value in evaluating the reduced chi-squared statistic. Like the toy model statistical analysis, it was assumed that there were no parameters in the models, because all methods were exclusively mathematically derived from the data.


For the KS-EDF method, the reduced chi-squared statistic was 0.1378, and for the variance subtraction method, it was 14.25. Both values are an order of magnitude away from unity, which mainly demonstrates that the KS-EDF overestimates uncertainties, and additionally the pitfalls of the variance subtraction method. The results of this test does not immediately disqualify either method, but it does provide credence to the hypothesis in section \ref{sec:toy_models} that these methods have specific points of failure. It is also important to note that there were only 10 degrees of freedom for these statistics.




%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "paper"
%%% En